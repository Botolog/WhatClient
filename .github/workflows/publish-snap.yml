name: Publish Snap to Store

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      snap-filename:
        description: "Name of the snap file to publish"
        required: false
        type: string
        default: "chitchat_*.snap"
      channel:
        description: "Snap Store channel to publish to"
        required: false
        type: string
        default: "stable"
    secrets:
      SNAPCRAFT_TOKEN:
        required: true

jobs:
  publish:
    runs-on: ubuntu-22.04
    steps:
      - name: Install snapcraft
        run: |
          sudo snap install snapcraft --classic

      - name: Download snap artifact
        uses: actions/download-artifact@v4
        with:
          name: snap-package

      - name: Login to Snap Store
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_TOKEN }}
        run: |
          echo "$SNAPCRAFT_STORE_CREDENTIALS" | snapcraft login --with -

      - name: Publish to Snap Store
        run: |
          SNAP_FILE="${{ inputs.snap-filename }}"
          CHANNEL="${{ inputs.channel }}"
          echo "Publishing $SNAP_FILE to $CHANNEL channel..."
          snapcraft upload --release=$CHANNEL $SNAP_FILE
          echo "âœ“ Successfully published to $CHANNEL!"

      - name: Get snap info
        run: |
          snapcraft status chitchat
